<?xml version="1.0" encoding="UTF-8"?>
<con:testSuite id="9f9adf6a-3cbd-4d20-91ce-1658c130641d" name="OJVS_SoapUI_Suite_VuConnect" xmlns:con="http://eviware.com/soapui/config"><con:description>Staging 
publicKey = "RcXa2QSuNz1XeHmcTuz9";
privateKey = "lpC5qHPucRNy3d9L2wgT";

prod
private=m6IkzXPFpcDu4G8c4kkt
public=vftxCvFFMyOIjP1wbcv6

Talend
http://192.168.249.94:8088/tpay/billing
http://192.168.249.94:8090/vuconnect/billing
	

*** Successful Renewal Callback/Notification Scenario : 
(
    [action] => SubscriptionChargingNotification
    [subscriptionContractId] => 132293
    [customerAccountNumber] => test
    [paymentTransactionStatusCode] => PaymentCompletedSuccessfully
    [transactionId] => 277293
    [amountCharged] => 0.75
    [currencyCode] => EGP
    [paymentDate] => 2015-11-28 02:00:02Z
    [errorMessage] => 
    [nextPaymentDate] => 2015-11-29 01:59:31Z
    [productCatalogName] => Video Store
    [productId] => 75
    [digest] => vftxCvFFMyOIjP1wbcv6:928d39e17c7786ec757d7e8416daf3d422779e5365b427da323c3c52e298eafa
)

*** Failure (Low Balance) Renewal Callback/Notification Scenario :

10:40:07.8587620::  
10:40:07.8588750:: Array
(
    [action] => SubscriptionChargingNotification
    [subscriptionContractId] => 132336
    [customerAccountNumber] => test
    [paymentTransactionStatusCode] => NotEnoughCredit
    [transactionId] => 277545
    [amountCharged] => 0.75
    [currencyCode] => EGP
    [paymentDate] => 
    [errorMessage] => 
    [nextPaymentDate] => 2015-12-01 12:39:33Z
    [productCatalogName] => Video Store
    [productId] => 75
    [digest] => vftxCvFFMyOIjP1wbcv6:216f86a7849ad1e7e98c144933a2faf094a6cdff55654794305bd4769cec6f5a
)


*** Subscription Contract Cancelled Callback/Notification Scenario :

06:22:13.9681740::  
06:22:13.9683080:: Array
(
    [action] => SubscriptionContractStatusChanged
    [subscriptionContractId] => 132293
    [customerAccountNumber] => test
    [status] => Canceled
    [reason] => 
    [digest] => vftxCvFFMyOIjP1wbcv6:40b5f2a8ed64850b68435eecc46dc1e2731a378a1406c3d17d9af6ccb12a35e5
)


*** Subscription Contract Suspended Callback/Notification Scenario :

06:44:26.9822420::  
06:44:26.9823730:: Array
(
    [action] => SubscriptionContractStatusChanged
    [subscriptionContractId] => 132296
    [customerAccountNumber] => test
    [status] => Suspended
    [reason] => 
    [digest] => vftxCvFFMyOIjP1wbcv6:8ea30c75b894a4f5ae18a318f2d6fd7401c9cc5f69b2bd8590bb6550c13c96c0
)


*** Successful AddSubscriptionContractRequest Callback/Notification Scenario (Free Trial User Flow):

07:58:31.4825010::  
07:58:31.4826280:: Array
(
    [action] => SubscriptionContractStatusChanged
    [subscriptionContractId] => 132297
    [customerAccountNumber] => test
    [status] => Active
    [reason] => 
    [digest] => vftxCvFFMyOIjP1wbcv6:39779bb564be6b9cf92db04bc26afb38b4b82e0f4a9113f98591e18c4470c205
)

*** Successful Free Trial to Activate Callback/Notification received after 24 hours (Free Trial User Flow) Scenario :

08:00:07.4243110::  
08:00:07.4244920:: Array
(
    [action] => SubscriptionChargingNotification
    [subscriptionContractId] => 132297
    [customerAccountNumber] => test
    [paymentTransactionStatusCode] => PaymentCompletedSuccessfully
    [transactionId] => 277435
    [amountCharged] => 0.75
    [currencyCode] => EGP
    [paymentDate] => 2015-11-29 10:00:05Z
    [errorMessage] => 
    [nextPaymentDate] => 2015-11-30 09:58:30Z
    [productCatalogName] => Video Store
    [productId] => 75
    [digest] => vftxCvFFMyOIjP1wbcv6:3aac2e2e77e9d0bdd6f5e60003686d5a0868c9bb65b91677501fd9a53fbaca44
)


*** Successful AddSubscriptionContractRequest Callback/Notification (Direct Paid User Flow) Scenario :

08:50:24.8931070::  
08:50:24.8932270:: Array
(
    [action] => SubscriptionContractStatusChanged
    [subscriptionContractId] => 132298
    [customerAccountNumber] => test
    [status] => Active
    [reason] => 
    [digest] => vftxCvFFMyOIjP1wbcv6:eebcab6365e2260c9b5ad5631630828026f85f3f1014f9d2d07249c65c10dc8e
)
</con:description><con:settings><con:setting id="9f9adf6a-3cbd-4d20-91ce-1658c130641dfileName">OJVS_SoapUI_Suite_VuConnect</con:setting></con:settings><con:runType>SEQUENTIAL</con:runType><con:properties><con:property><con:name>filePrefix</con:name><con:value>ojvs/ojvs_suite_</con:value></con:property><con:property><con:name>outputfile</con:name><con:value>F://baas_workspace/Output/ojvs/ojvs_suite_2016_06_28-20-01.txt</con:value></con:property><con:property><con:name>total</con:name><con:value>0</con:value></con:property><con:property><con:name>pass</con:name><con:value>0</con:value></con:property><con:property><con:name>fail</con:name><con:value>0</con:value></con:property><con:property><con:name>duration</con:name><con:value>113213</con:value></con:property></con:properties><con:setupScript>import java.text.*
import java.util.*
long startTime = System.currentTimeMillis();
context.setProperty("start",startTime)

Properties properties = new Properties()
File propertiesFile = new File(context.expand('${#Global#property_file}'))
propertiesFile.withInputStream {
    properties.load(it)
}

testSuite.setPropertyValue( "duration","0")
testSuite.setPropertyValue( "total","0")
testSuite.setPropertyValue( "pass","0")
testSuite.setPropertyValue( "fail","0")


def path=context.expand('${#Global#output_path}')

Date date = new Date();
DateFormat dateFormat = new SimpleDateFormat("yyyy_MM_dd-HH-mm");
def df = dateFormat.format(date);
def prefix=testSuite.getPropertyValue("filePrefix")+df+".txt"

def resultFile = path+prefix
 File file = new File(resultFile)
testSuite.setPropertyValue( "outputfile", resultFile )
context.setProperty("resultfile",file)
</con:setupScript><con:tearDownScript><![CDATA[import javax.mail.*;
import javax.activation.*
import javax.mail.internet.*;
import java.util.*;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.io.BufferedReader;
import java.io.FileReader;
import java.io.IOException;
import com.eviware.soapui.model.project.ProjectFactoryRegistry
import com.eviware.soapui.impl.wsdl.WsdlProjectFactory

long endTime = System.currentTimeMillis();
long duration=endTime-context.start

testSuite.setPropertyValue( "duration",duration.toString())

 // Recipient's email ID needs to be mentioned.
        String to = context.expand('${#Global#recipients}')
        
       // Sender's email ID needs to be mentioned
      String from = "vuclipqauser@gmail.com";//change accordingly
      final String username = "vuclipqauser";//change accordingly
      final String password = "vucliP@123";//change accordingly

      // Assuming you are sending email through relay.jangosmtp.net
      String host = "smtp.gmail.com";

      def props = new Properties();
      props.put("mail.smtp.auth", "true");
      props.put("mail.smtp.starttls.enable", "true");
      props.put("mail.smtp.host", host);
      props.put("mail.smtp.port", "587");

      // Get the Session object.
      Session session = Session.getInstance(props,
      new javax.mail.Authenticator() {
         protected PasswordAuthentication getPasswordAuthentication() {
            return new PasswordAuthentication(username, password);
         }
      });

      try {
      	int total=0
      	int pass=0
      	int fail=0
       String filename = testSuite.getPropertyValue( "outputfile")
      
           File outputfile=new File(filename)
         // Create a default MimeMessage object.
         Message message = new MimeMessage(session);

         // Set From: header field of the header.
         message.setFrom(new InternetAddress(from));

         // Set To: header field of the header.
         message.setRecipients(Message.RecipientType.TO,
         InternetAddress.parse(to));

         // Set Subject: header field
         message.setSubject(testSuite.name +" :BaaS Automaiton Test Execution Report");
     
         // Create the message part
            BodyPart messageBodyPart = new MimeBodyPart();
            StringBuffer emailMessage = new StringBuffer("Dear All,");
            emailMessage.append("<br>");
            emailMessage.append("<h3>Find below "+testSuite.name+" Test Excecution Report.</h3>");
                                 
               BufferedReader br = null;	
			String sCurrentLine;
			br = new BufferedReader(new FileReader(outputfile));
			br2 = new BufferedReader(new FileReader(outputfile));

         while ((sCurrentLine = br.readLine()) != null) {
			if(sCurrentLine.contains("Total Executed"))
			{
				total=total+(sCurrentLine.split("=")[1]).toInteger()
			}
			else if(sCurrentLine.contains("Total Pass"))
			{
				pass=pass+(sCurrentLine.split("=")[1]).toInteger()
			}
			else if(sCurrentLine.contains("Total Fail"))
			{
				fail=fail+(sCurrentLine.split("=")[1]).toInteger()
			}}

			float passPercent= (pass/total)*100
			float failPercent=(fail/total)*100
			
			def p=   Math.round(passPercent * 100) / 100
			def f=    Math.round(failPercent * 100) / 100
		 Properties prop = new Properties();
		 FileInputStream fis = new FileInputStream(context.expand('${#Global#output_path}')+"/master.properties");
           prop.load(fis);
            fis.close();
	       OutputStream output = new FileOutputStream(context.expand('${#Global#output_path}')+"/master.properties");	          
	       prop.setProperty(testSuite.name, total+"*"+pass+"*"+fail+"*"+p+"*"+f+"*"+duration+"*"+filename);	
		    // save properties to project root folder
		     prop.store(output, null);
		
			 int n=1
			//Summary
			 emailMessage.append("<!DOCTYPE html><html><head><style>table, th, td {    border: 1px solid black;}</style></head><body> <table style='width:25%' ; frame=box ><tr><th>Total Executed</th><th>Passed</th><th>Failed</th><th>Pass %</th><th>Fail %</th></tr><tr><td align='center'>"+total+"</td><td bgcolor='##00ff00' ; align='center'>"+pass+"</td> <td bgcolor='#FF0000' ; align='center'>"+fail+"</td><td bgcolor='##00ff00' ; align='center'>"+p+"</td> <td bgcolor='#FF0000' ; align='center'>"+f+"</td>  </tr></table>")
		
             // Server Details
		    emailMessage.append("<p><b>BaaS Server:</b>"+context.expand('${#Global#baas_endpoint}')+"</p>");
              emailMessage.append("<p><b>Talend Server:</b>"+context.expand('${#Global#talend_endpoint}')+"</p>");
			
			emailMessage.append("<table  frame=box ><tr><th>S.R.</th><th>Test Case Name</th><th>Status</th></tr>")
			while ((sCurrentLine = br2.readLine()) != null) {

	                if(sCurrentLine.contains("no record found in log api db")){
      		
      		 emailMessage.append("<tr><td align='center'>"+n+"</td><td bgcolor='#D3D3D3'>"+sCurrentLine+"</td><td bgcolor='#D3D3D3'>FAIL</td></tr>")
      			 
      			  
      			  n++
      			 }
      			 		else if (sCurrentLine.contains("failed")  || sCurrentLine.contains("API Response is not proper") )
				{
					
					 emailMessage.append("<tr><td align='center'>"+n+"</td><td bgcolor='#FF0000'>"+sCurrentLine+"</td><td bgcolor='#FF0000'>FAIL</td></tr>")
				      			  
					 n++
					
				}	
				 else if(sCurrentLine.contains("passed")){
      		
      			 emailMessage.append("<tr><td align='center'>"+n+"</td><td>"+sCurrentLine+"</td><td bgcolor='##00ff00'>PASS</td></tr>");
      			  n++
      			 }
				
			
                     else if(sCurrentLine.contains("Expected"))
      			 {
      			 String failresult=("<tr>Expected<td></td>"+sCurrentLine+"<td></td></tr>");
      			  emailMessage.append(failresult)
      			 	
      			 }
      			   else if( sCurrentLine.contains("Found"))
      			 {
      			 String failresult=("<tr>Found<td></td>"+sCurrentLine+"<td></td></tr>");
      			  emailMessage.append(failresult)
      			 	
      			 }
      		
			}
			emailMessage.append("</table>")
		//Signature of the email body	
		   emailMessage.append("<br>");
            emailMessage.append("Thanks & Regards");
            emailMessage.append("<br>");
            emailMessage.append("Vuclip QA");
             emailMessage.append("<br>");
            

            emailMessage.append("<p>*** This is an automatically generated email, please do not reply ***</p>");

         // Create a multipar message
         Multipart multipart = new MimeMultipart();
         

         // Part two is attachment
         messageBodyPart = new MimeBodyPart();
         messageBodyPart.setContent(emailMessage.toString(),"text/html")
         
         multipart.addBodyPart(messageBodyPart);
         //String filename = context.getProperty("resultfile")

         // Send the complete message parts
         message.setContent(multipart);

      // Send message
         if (context.expand('${#Global#is_mail_sent}').toUpperCase()=='TRUE')
         {
         Transport.send(message);
         }
         else{log.info "No Email Sent"}
      } catch (MessagingException e) {
            throw new RuntimeException(e);
      }


]]></con:tearDownScript><con:reportParameters/></con:testSuite>